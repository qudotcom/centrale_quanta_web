{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

<div class="game-layout">
    
    <div class="board-zone">
        <div id="myBoard" style="width: 100%"></div>
        <div class="board-status">
            STATUS: <span style="color: var(--primary);">CONNECTED</span><br>
            <small>Drag for Standard Move | Terminal for Split (^)</small>
        </div>
    </div>

    <div class="control-zone">
        <div class="info-card">
            <div style="border-bottom: 1px solid var(--primary-dim); margin-bottom: 10px; padding-bottom: 5px;">
                MATCH #{{ match.id }}
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>WHITE:</span> <span>{{ match.player1.username }}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>BLACK:</span> <span>{{ match.player2.username }}</span>
            </div>
        </div>

        <div class="logs" id="game-logs">
            <div>> Initializing Quantum Manifold...</div>
            <div>> Match Loaded.</div>
            {% if match.player1.username == 'CPU_AI' %}
            <div>> AI is White. Calculation initiated...</div>
            {% endif %}
        </div>

        <div class="command-line">
            <label>QUANTUM INPUT:</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="move-input" placeholder="e.g. b1a3^b1c3" autocomplete="off">
                <button onclick="submitManualMove()" class="btn">EXECUTE</button>
            </div>
        </div>
    </div>

</div>

<div id="game-data" 
     data-match-id="{{ match.id }}" 
     data-fen="{{ fen }}" 
     data-orientation="{{ orientation }}"
     style="display: none;">
</div>

<script>
var board = null;
var gameMatchId = document.getElementById('game-data').dataset.matchId;
var startFen = document.getElementById('game-data').dataset.fen;
var orientationType = document.getElementById('game-data').dataset.orientation;

function onDrop (source, target) {
    if (source === target) return;
    var move = source.toLowerCase() + target.toLowerCase();
    submitMoveToServer(move);
}

// Initialize Board with Correct Orientation
var config = {
    draggable: true,
    position: startFen,
    orientation: orientationType, // FLIPS BOARD IF USER IS BLACK
    onDrop: onDrop,
    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
}
board = Chessboard('myBoard', config)
window.addEventListener('resize', board.resize);

async function submitMoveToServer(moveStr) {
    const logPanel = document.getElementById('game-logs');
    logPanel.innerHTML += `<div>> Sending: ${moveStr}...</div>`;
    logPanel.scrollTop = logPanel.scrollHeight;

    try {
        const response = await fetch(`/tournament/move/${gameMatchId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ move_str: moveStr })
        });
        const data = await response.json();

        if (data.success) {
            logPanel.innerHTML += `<div style="color: #fff;">> SUCCESS.</div>`;
            board.position(data.fen);
        } else {
            logPanel.innerHTML += `<div style="color: red;">> ERROR: ${data.message}</div>`;
            board.position(startFen); // Snapback
        }
    } catch (error) {
        logPanel.innerHTML += `<div style="color: red;">> CONNECTION LOST</div>`;
    }
}

function submitManualMove() {
    var input = document.getElementById('move-input');
    submitMoveToServer(input.value);
    input.value = '';
}

document.getElementById('move-input').addEventListener("keypress", function(e) {
    if (e.key === "Enter") submitManualMove();
});
</script>

<style>
    /* CSS GRID FOR STABILITY */
    .game-layout {
        display: grid;
        grid-template-columns: 1fr 350px; /* Board takes remaining space, controls fixed */
        gap: 2rem;
        align-items: start;
        max-width: 1100px;
        margin: 2rem auto;
    }

    @media (max-width: 900px) {
        .game-layout {
            grid-template-columns: 1fr; /* Stack on mobile */
        }
    }

    .board-zone {
        background: rgba(0, 20, 0, 0.3);
        padding: 20px;
        border: 1px solid var(--primary-dim);
    }

    .info-card {
        border: 1px solid var(--primary);
        padding: 1rem;
        background: rgba(0, 20, 0, 0.8);
        font-weight: bold;
    }

    .logs {
        border: 1px dashed var(--primary-dim);
        height: 350px;
        overflow-y: auto;
        padding: 0.5rem;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        color: var(--primary);
        background: black;
        margin-top: 1rem;
    }

    .board-status {
        margin-top: 15px; 
        color: var(--primary-dim); 
        font-size: 0.9rem; 
        text-align: center;
    }

    /* THEME OVERRIDES */
    .board-b72b1 {
        border: 5px solid var(--primary-dim);
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
    }
    .black-3c85d { background-color: #000000 !important; color: var(--primary); }
    .white-1e1d7 { background-color: #0a2a0a !important; color: var(--primary); }
    
    .piece-417db {
        filter: invert(1) sepia(1) saturate(5) hue-rotate(90deg) drop-shadow(0 0 5px var(--primary));
        opacity: 0.95;
    }
    .piece-417db:hover {
        filter: invert(1) sepia(1) saturate(10) hue-rotate(90deg) drop-shadow(0 0 15px var(--primary));
        cursor: grab;
    }
</style>
{% endblock %}
