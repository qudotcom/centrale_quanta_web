{% extends "base.html" %}

{% block content %}
<div class="dashboard-wrapper">
    
    <div class="board-column">
        <div class="board-frame">
            <div id="quantum-board" class="board-grid"></div>
        </div>
        <div class="board-footer">
            <div class="status-dot"></div> QUANTUM FIELD ACTIVE
        </div>
    </div>

    <div class="hud-column">
        
        <div class="panel kpi-panel">
            <div class="panel-header">>> PROBABILITY WAVE (MATERIAL)</div>
            <div class="kpi-container">
                <div class="kpi-labels">
                    <span style="color: #0ff;">WHITE</span>
                    <span style="color: #f70;">BLACK</span>
                </div>
                <div class="progress-track">
                    <div id="probability-bar" class="progress-fill" style="width: 50%;"></div>
                </div>
                <div class="kpi-score" id="material-score">EQUAL STATE</div>
            </div>
        </div>

        <div class="panel info-panel">
            <div class="info-row">
                <span class="label">P1 (WHITE):</span> 
                <span class="val">{{ match.player1.username }}</span>
            </div>
            <div class="info-row">
                <span class="label">P2 (BLACK):</span> 
                <span class="val">{{ match.player2.username }}</span>
            </div>
            <div class="info-row">
                <span class="label">YOUR COLOR:</span> 
                <span class="val" style="color: #fff; border: 1px solid #fff; padding: 0 5px;">{{ user_color|upper }}</span>
            </div>
        </div>

        <div class="panel logs-panel" id="logs">
            <div class="log-entry">> System initialized.</div>
            <div class="log-entry">> Waiting for input...</div>
        </div>

        <div class="panel input-panel">
            <label>COMMAND INPUT:</label>
            <div class="input-wrapper">
                <input type="text" id="move-input" placeholder="Select squares..." autocomplete="off">
                <button onclick="sendMove()" class="btn-exec">SEND</button>
            </div>
            <div class="tips">
                * Click [Source] then [Target] to move.<br>
                * Split: [Source] -> [Target1] -> [Target2]
            </div>
        </div>

    </div>
</div>

<div id="game-data" 
     data-match-id="{{ match.id }}" 
     data-board='{{ board_data|safe }}' 
     data-user-color="{{ user_color }}">
</div>

<script>
// --- ASSETS & CONSTANTS ---
const PIECE_URL = "https://upload.wikimedia.org/wikipedia/commons/thumb/";
const PIECE_MAP = {
    'r': 'f/ff/Chess_rdt45.svg/80px-Chess_rdt45.svg.png', 'n': 'e/ef/Chess_ndt45.svg/80px-Chess_ndt45.svg.png',
    'b': '9/98/Chess_bdt45.svg/80px-Chess_bdt45.svg.png', 'q': '4/47/Chess_qdt45.svg/80px-Chess_qdt45.svg.png',
    'k': 'f/f0/Chess_kdt45.svg/80px-Chess_kdt45.svg.png', 'p': 'c/c7/Chess_pdt45.svg/80px-Chess_pdt45.svg.png',
    'R': '7/72/Chess_rlt45.svg/80px-Chess_rlt45.svg.png', 'N': '7/70/Chess_nlt45.svg/80px-Chess_nlt45.svg.png',
    'B': 'b/b1/Chess_blt45.svg/80px-Chess_blt45.svg.png', 'Q': '1/15/Chess_qlt45.svg/80px-Chess_qlt45.svg.png',
    'K': '4/42/Chess_klt45.svg/80px-Chess_klt45.svg.png', 'P': '4/45/Chess_plt45.svg/80px-Chess_plt45.svg.png'
};
const COLS = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
const ROWS = ['8', '7', '6', '5', '4', '3', '2', '1'];

// --- STATE ---
const gameDataEl = document.getElementById('game-data');
const matchId = gameDataEl.dataset.matchId;
const userColor = gameDataEl.dataset.userColor;
let currentBoardData = JSON.parse(gameDataEl.dataset.board);
let selectedSquares = [];

// --- KPI LOGIC ---
function updateKPIs(boardData) {
    let whiteScore = 0;
    let blackScore = 0;
    const values = { 'p':1, 'n':3, 'b':3, 'r':5, 'q':9, 'k':0 };

    for (let key in boardData) {
        let p = boardData[key];
        let val = values[p.toLowerCase()] || 0;
        if (p === p.toUpperCase()) whiteScore += val; // White is Upper
        else blackScore += val;
    }

    const total = whiteScore + blackScore;
    let percent = 50;
    if (total > 0) percent = (whiteScore / total) * 100;

    const bar = document.getElementById('probability-bar');
    const label = document.getElementById('material-score');
    
    bar.style.width = percent + "%";
    
    if (percent > 55) label.innerText = "WHITE ADVANTAGE";
    else if (percent < 45) label.innerText = "BLACK ADVANTAGE";
    else label.innerText = "BALANCED STATE";
}

// --- RENDER ---
function renderBoard(boardData) {
    const boardEl = document.getElementById('quantum-board');
    boardEl.innerHTML = ''; 

    // Orientation Logic
    let rRows = (userColor === 'black') ? [...ROWS].reverse() : ROWS;
    let rCols = (userColor === 'black') ? [...COLS].reverse() : COLS;

    rRows.forEach(row => {
        rCols.forEach(col => {
            const squareId = col + row;
            const sq = document.createElement('div');
            sq.className = 'square';
            sq.id = squareId;
            
            // Checkerboard
            const isDark = (COLS.indexOf(col) + parseInt(row)) % 2 === 0;
            sq.classList.add(isDark ? 'sq-dark' : 'sq-light');

            if (boardData[squareId]) {
                const p = boardData[squareId];
                const img = document.createElement('img');
                img.src = PIECE_URL + PIECE_MAP[p];
                img.className = 'piece-img';
                
                // --- VISUAL FIX: COLOR CODING ---
                if (p === p.toUpperCase()) {
                    img.classList.add('filter-white'); // White Pieces
                } else {
                    img.classList.add('filter-black'); // Black Pieces
                }
                sq.appendChild(img);
            }

            sq.onclick = () => handleSquareClick(squareId);
            boardEl.appendChild(sq);
        });
    });
    
    updateKPIs(boardData);
}

// --- INTERACTION ---
function handleSquareClick(id) {
    const el = document.getElementById(id);
    const input = document.getElementById('move-input');

    if (selectedSquares.includes(id)) {
        selectedSquares = selectedSquares.filter(s => s !== id);
        el.classList.remove('sq-selected');
        return;
    }

    if (selectedSquares.length < 3) {
        selectedSquares.push(id);
        el.classList.add('sq-selected');
    }

    // Auto-Type Logic
    if (selectedSquares.length === 2) {
        input.value = selectedSquares.join('');
    } else if (selectedSquares.length === 3) {
        // Assume Split: Src -> T1 -> T2
        let s = selectedSquares[0];
        let t1 = selectedSquares[1];
        let t2 = selectedSquares[2];
        input.value = `${s}${t1}^${s}${t2}`;
    }
}

async function sendMove() {
    const input = document.getElementById('move-input');
    const moveStr = input.value;
    const logEl = document.getElementById('logs');

    if (!moveStr) return;

    logEl.innerHTML += `<div class="log-entry">> Sending: ${moveStr}</div>`;
    logEl.scrollTop = logEl.scrollHeight;

    try {
        const response = await fetch(`/tournament/move/${matchId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ move_str: moveStr })
        });
        const res = await response.json();

        if (res.success) {
            logEl.innerHTML += `<div class="log-success">> MOVE ACCEPTED.</div>`;
            currentBoardData = res.board_data;
            renderBoard(currentBoardData);
            selectedSquares = [];
            input.value = '';
        } else {
            logEl.innerHTML += `<div class="log-error">> ERROR: ${res.message}</div>`;
        }
    } catch (e) {
        logEl.innerHTML += `<div class="log-error">> SIGNAL LOST</div>`;
    }
}

renderBoard(currentBoardData);
</script>

<style>
    /* --- LAYOUT --- */
    .dashboard-wrapper {
        display: grid;
        grid-template-columns: 450px 1fr;
        gap: 30px;
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
    }

    /* --- BOARD --- */
    .board-column {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .board-frame {
        border: 4px solid var(--primary-dim);
        padding: 5px;
        background: #000;
        box-shadow: 0 0 25px rgba(0, 255, 65, 0.15);
    }
    .board-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        width: 400px;
        height: 400px;
    }
    .square {
        width: 100%; height: 100%;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer;
    }
    .sq-light { background-color: #1a2a1a; }
    .sq-dark { background-color: #050505; }
    .sq-selected { background-color: rgba(0, 255, 255, 0.3) !important; box-shadow: inset 0 0 10px cyan; }

    /* --- PIECE VISIBILITY FILTERS --- */
    .piece-img { width: 85%; transition: 0.2s; }
    
    /* White Pieces: CYAN GLOW */
    .filter-white {
        filter: invert(1) sepia(1) saturate(5) hue-rotate(130deg) brightness(1.5) drop-shadow(0 0 3px cyan);
    }
    /* Black Pieces: ORANGE/RED GLOW */
    .filter-black {
        filter: invert(1) sepia(1) saturate(5) hue-rotate(-50deg) brightness(1.2) drop-shadow(0 0 3px red);
    }

    /* --- HUD PANELS --- */
    .hud-column {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .panel {
        background: rgba(0, 15, 0, 0.8);
        border: 1px solid var(--primary-dim);
        padding: 15px;
    }
    .panel-header {
        border-bottom: 1px solid var(--primary-dim);
        margin-bottom: 10px;
        font-size: 0.8rem;
        color: var(--primary);
    }

    /* KPI BAR */
    .kpi-container { text-align: center; }
    .kpi-labels { display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 5px; }
    .progress-track {
        height: 10px; background: #220000; border: 1px solid #555; position: relative;
    }
    .progress-fill {
        height: 100%; background: cyan; transition: width 0.5s;
        box-shadow: 0 0 10px cyan;
    }
    .kpi-score { margin-top: 5px; font-size: 0.8rem; color: #fff; }

    /* LOGS */
    .logs-panel {
        height: 200px; overflow-y: auto; background: #000;
        font-family: monospace; font-size: 0.8rem;
    }
    .log-success { color: #0f0; }
    .log-error { color: #f44; }

    /* CONTROLS */
    .input-wrapper { display: flex; gap: 10px; }
    .btn-exec {
        background: var(--primary); color: #000; border: none; padding: 10px 20px;
        font-weight: bold; cursor: pointer;
    }
    .btn-exec:hover { box-shadow: 0 0 10px var(--primary); }
</style>
{% endblock %}
