{% extends "base.html" %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="board-column">
        <div class="board-frame">
            <div id="quantum-board" class="board-grid"></div>
        </div>
    </div>

    <div class="hud-column">
        
        <div class="panel turn-panel">
            <div class="panel-header">>> ACTIVE SIGNAL</div>
            <div id="turn-display" class="turn-box"></div>
            <div id="ai-loader" class="blink" style="display: none; color: #0f0; margin-top:10px;">AI COMPUTING...</div>
        </div>

        <div class="panel info-panel">
            <div class="info-row"><span>WHITE:</span> {{ match.player1.username }}</div>
            <div class="info-row"><span>BLACK:</span> {{ match.player2.username }}</div>
            <div class="info-row"><span>YOU:</span> <strong style="color:white">{{ user_color|upper }}</strong></div>
        </div>

        <div class="panel toggle-panel">
             <div class="panel-header">>> INTERFACE MODE</div>
             <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 10px;">
                 <span id="mode-label" style="color: #888;">STANDARD (2 Clicks)</span>
                 <label class="switch">
                   <input type="checkbox" id="quantum-toggle" onclick="toggleMode()">
                   <span class="slider round"></span>
                 </label>
             </div>
        </div>

        <div class="panel logs-panel" id="logs">
            <div class="log-entry">> Uplink Established.</div>
        </div>

        <div class="panel tips-panel" style="font-size: 0.7rem; color: #666;">
            <strong>CONTROLS:</strong><br>
            • Standard Mode: Click [Source] then [Target]. Auto-sends.<br>
            • Quantum Mode: Click 3 squares for Split/Merge. Auto-sends.<br>
            • Click selected square again to cancel.
        </div>

    </div>
</div>

<div id="game-data" 
     data-match-id="{{ match.id }}" 
     data-board='{{ board_data|safe }}' 
     data-user-color="{{ user_color }}"
     data-turn="{{ current_turn }}">
</div>

<script>
// --- CUSTOM SVG PIECE DEFINITIONS (Futuristic Icons) ---
// These are base64 encoded SVGs for abstract, role-based pieces.
const SVG_BASE = "data:image/svg+xml;base64,";
const PIECES = {
    // PAWN (Simple Triangle/Chevron)
    'P': SVG_BASE + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,15 L85,85 L15,85 Z" class="piece-fill"/></svg>'),
    // ROOK (Tower/Shield)
    'R': SVG_BASE + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M20,20 L40,20 L40,30 L60,30 L60,20 L80,20 L80,80 L20,80 Z" class="piece-fill"/></svg>'),
    // KNIGHT (Abstract Horse Head)
    'N': SVG_BASE + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M30,80 L70,80 L60,30 L75,20 L50,10 L30,25 L40,40 L30,80 Z" class="piece-fill"/></svg>'),
    // BISHOP (Mitre/Star)
    'B': SVG_BASE + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="50,5 20,85 80,85" class="piece-fill"/><circle cx="50" cy="30" r="10" class="piece-hole"/></svg>'),
    // QUEEN (Crown with Spikes)
    'Q': SVG_BASE + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M10,80 L20,30 L40,50 L50,10 L60,50 L80,30 L90,80 Z" class="piece-fill"/></svg>'),
    // KING (Cross/Helmet)
    'K': SVG_BASE + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M45,10 L55,10 L55,30 L75,30 L75,40 L55,40 L55,80 L45,80 L45,40 L25,40 L25,30 L45,30 Z" class="piece-fill"/></svg>')
};

// Map lowercases to the same SVGs
const PIECE_MAP = { ...PIECES, 'p': PIECES.P, 'r': PIECES.R, 'n': PIECES.N, 'b': PIECES.B, 'q': PIECES.Q, 'k': PIECES.K };

const COLS = ['a','b','c','d','e','f','g','h'];
const ROWS = ['8','7','6','5','4','3','2','1'];

// --- STATE ---
const gameDataEl = document.getElementById('game-data');
const matchId = gameDataEl.dataset.matchId;
const userColor = gameDataEl.dataset.userColor;
let currentTurn = gameDataEl.dataset.turn;
let currentBoardData = JSON.parse(gameDataEl.dataset.board);
let selectedSquares = [];
let isQuantumMode = false; // Track current interaction mode

// --- UI HELPERS ---
function updateUIState(isWaiting) {
    // Disable board interaction while waiting
    document.getElementById('quantum-board').style.pointerEvents = isWaiting ? 'none' : 'auto';
    document.getElementById('ai-loader').style.display = isWaiting ? 'block' : 'none';
    // Disable toggle while waiting
    document.getElementById('quantum-toggle').disabled = isWaiting;
}

function toggleMode() {
    isQuantumMode = document.getElementById('quantum-toggle').checked;
    const label = document.getElementById('mode-label');
    if (isQuantumMode) {
        label.innerText = "QUANTUM ACTIVE (3 Clicks)";
        label.style.color = "cyan";
        document.getElementById('logs').innerHTML += `<div class="log-entry" style="color:cyan">> Quantum Modifiers Engaged.</div>`;
    } else {
        label.innerText = "STANDARD (2 Clicks)";
        label.style.color = "#888";
        document.getElementById('logs').innerHTML += `<div class="log-entry">> Standard Physics Engaged.</div>`;
    }
    clearSelection(); // Reset selection on mode change
}

// --- RENDER ENGINE ---
function renderBoard(boardData) {
    const boardEl = document.getElementById('quantum-board');
    boardEl.innerHTML = ''; 
    let rRows = (userColor === 'black') ? [...ROWS].reverse() : ROWS;
    let rCols = (userColor === 'black') ? [...COLS].reverse() : COLS;

    rRows.forEach(row => {
        rCols.forEach(col => {
            const id = col + row;
            const sq = document.createElement('div');
            sq.className = 'square';
            sq.id = id;
            sq.classList.add((COLS.indexOf(col)+parseInt(row))%2===0 ? 'sq-dark':'sq-light');

            if (boardData[id]) {
                const p = boardData[id];
                const img = document.createElement('img');
                img.src = PIECE_MAP[p];
                // Apply CSS coloring classes based on case
                img.className = 'piece-svg ' + (p===p.toUpperCase() ? 'svg-white':'svg-black');
                sq.appendChild(img);
            }
            sq.onclick = () => handleSquareClick(id);
            boardEl.appendChild(sq);
        });
    });
    
    const turnEl = document.getElementById('turn-display');
    turnEl.innerHTML = currentTurn === 'white' ? '<span style="color:#0ff">■ WHITE TO MOVE</span>' : '<span style="color:#f70">■ BLACK TO MOVE</span>';
    
    const isUserTurn = currentTurn === userColor;
    updateUIState(!isUserTurn);
}

// --- NEW CLICK LOGIC (AUTO-SUBMIT) ---
function handleSquareClick(id) {
    if (currentTurn !== userColor) return; 
    const el = document.getElementById(id);

    // Deselect if clicked again
    if (selectedSquares.includes(id)) {
        clearSelection();
        return;
    }

    // Add selection based on mode limits
    const limit = isQuantumMode ? 3 : 2;
    if (selectedSquares.length < limit) {
        selectedSquares.push(id);
        // Visual feedback
        if (selectedSquares.length === 1) el.classList.add('sq-source');
        else if (selectedSquares.length === 2) el.classList.add('sq-t1');
        else if (selectedSquares.length === 3) el.classList.add('sq-t2');
    }

    // Check for Auto-Submit condition
    if (!isQuantumMode && selectedSquares.length === 2) {
        // Standard Move Complete
        const moveStr = selectedSquares.join('');
        sendMove(moveStr);
    } else if (isQuantumMode && selectedSquares.length === 3) {
        // Quantum Move Complete - Construct string
        // Assume Split: s1s2^s1t
        // Assume Merge: s1t^s2t
        // Basic heuristic: if s1 and s2 have pieces of same color, it's a merge. Otherwise split.
        // For simplicity in this UI version, we will assume standard Split notation: S -> T1 -> T2
        const moveStr = `${selectedSquares[0]}${selectedSquares[1]}^${selectedSquares[0]}${selectedSquares[2]}`;
        sendMove(moveStr);
    }
}

function clearSelection() {
    selectedSquares.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.remove('sq-source', 'sq-t1', 'sq-t2');
    });
    selectedSquares = [];
}

// --- NETWORK ---
async function sendMove(moveStr) {
    if (!moveStr) return;
    updateUIState(true);
    clearSelection(); // Clear visuals immediately upon sending
    
    document.getElementById('logs').innerHTML += `<div class="log-entry">> Sending: ${moveStr}</div>`;

    try {
        const res = await fetch(`/tournament/move/${matchId}`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ move_str: moveStr })
        });
        const data = await res.json();

        if (data.success) {
            document.getElementById('logs').innerHTML += `<div class="log-entry" style="color:#0f0">> Move Accepted.</div>`;
            currentBoardData = data.board_data;
            
            if (data.game_over) {
                alert(`GAME OVER! Winner: ${data.winner.toUpperCase()}`);
                currentTurn = 'none';
            } else if (data.ai_moved) {
                // AI moved, turn goes back to user
                 currentTurn = userColor;
            } else {
                // PVP move, toggle turn
                currentTurn = (currentTurn === 'white') ? 'black' : 'white';
            }
            renderBoard(currentBoardData);
        } else {
            document.getElementById('logs').innerHTML += `<div class="log-entry" style="color:#f44">> Error: ${data.message}</div>`;
            // Restore UI state if failed
            updateUIState(false);
        }
    } catch (e) { 
        console.error(e); 
        document.getElementById('logs').innerHTML += `<div class="log-entry" style="color:#f44">> Signal Lost.</div>`;
    }
}

// Initial check
if (currentTurn !== userColor) updateUIState(true);
renderBoard(currentBoardData);
</script>

<style>
    /* --- LAYOUT --- */
    .dashboard-wrapper { display: grid; grid-template-columns: 450px 1fr; gap: 20px; max-width: 900px; margin: 40px auto; }
    .board-grid { display: grid; grid-template-columns: repeat(8, 1fr); width: 400px; height: 400px; border: 4px solid var(--primary); }
    .square { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; }
    .sq-light { background: #1a2a1a; } .sq-dark { background: #000; }

    /* --- SELECTIONS --- */
    .sq-source { background: rgba(0, 255, 255, 0.3) !important; box-shadow: inset 0 0 10px cyan; }
    .sq-t1 { background: rgba(0, 255, 0, 0.3) !important; }
    .sq-t2 { background: rgba(255, 255, 0, 0.3) !important; }

    /* --- CUSTOM SVG PIECES --- */
    .piece-svg { width: 85%; transition: 0.2s; }
    /* Define colors for the SVG fill paths */
    .svg-white .piece-fill { fill: cyan; }
    .svg-white { filter: drop-shadow(0 0 5px cyan) drop-shadow(0 0 10px cyan); }
    
    .svg-black .piece-fill { fill: #ff4400; }
    .svg-black { filter: drop-shadow(0 0 5px #ff4400) drop-shadow(0 0 8px #f00); }
    
    .piece-hole { fill: #000; } /* For Bishop/Queen holes */

    /* --- PANELS --- */
    .panel { background: rgba(0, 15, 0, 0.9); border: 1px solid var(--primary-dim); padding: 15px; margin-bottom: 15px; }
    .panel-header { border-bottom: 1px solid var(--primary-dim); margin-bottom: 10px; font-size: 0.8rem; color: var(--primary); }
    .turn-box { font-size: 1.2rem; font-weight: bold; text-align: center; }
    .logs-panel { height: 120px; overflow-y: auto; background: #000; font-family: monospace; font-size: 0.8rem; color: var(--primary); }
    
    /* --- TOGGLE SWITCH --- */
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border: 1px solid #555; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 3px; background-color: #888; transition: .4s; }
    input:checked + .slider { background-color: rgba(0, 255, 255, 0.3); border-color: cyan; }
    input:checked + .slider:before { transform: translateX(26px); background-color: cyan; box-shadow: 0 0 10px cyan; }
    .slider.round { border-radius: 24px; } .slider.round:before { border-radius: 50%; }

    .blink { animation: blink 1s infinite; } @keyframes blink { 50% { opacity: 0; } }
</style>
{% endblock %}
