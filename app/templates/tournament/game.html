{% extends "base.html" %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="board-column">
        <div class="board-frame"><div id="quantum-board" class="board-grid"></div></div>
    </div>

    <div class="hud-column">
        
        <div class="panel turn-panel">
            <div class="panel-header">>> CHRONOMETER</div>
            <div class="timer-box" id="timer-white" style="border-color: cyan;">
                <span class="label">WHITE</span>
                <span class="digits" id="digits-white">10:00</span>
            </div>
            <div class="timer-box" id="timer-black" style="border-color: #f70; margin-top:10px;">
                <span class="label">BLACK</span>
                <span class="digits" id="digits-black">10:00</span>
            </div>
        </div>

        <div class="panel info-panel">
            <div class="info-row"><span>YOU:</span> <strong style="color:white">{{ user_color|upper }}</strong></div>
            <div class="info-row" id="turn-text" style="color: #0f0; margin-top:10px;">...</div>
        </div>

        <div class="panel input-panel">
            <div class="input-wrapper">
                <button onclick="toggleMode()" id="mode-btn" class="btn-mode">MODE: STANDARD</button>
                <button onclick="clearSelection()" class="btn-clear">RESET</button>
            </div>
        </div>
    </div>
</div>

<div id="game-data" 
     data-match-id="{{ match.id }}" 
     data-board='{{ board_data|safe }}' 
     data-user-color="{{ user_color }}"
     data-turn="{{ current_turn }}"
     data-p1="{{ p1_time }}"
     data-p2="{{ p2_time }}">
</div>

<script>
const COLS = ['a','b','c','d','e','f','g','h'];
const ROWS = ['8','7','6','5','4','3','2','1'];
const gameData = document.getElementById('game-data');
const matchId = gameData.dataset.matchId;
const userColor = gameData.dataset.userColor;
let currentTurn = gameData.dataset.turn;
let boardData = JSON.parse(gameData.dataset.board);
let p1Time = parseFloat(gameData.dataset.p1);
let p2Time = parseFloat(gameData.dataset.p2);
let selectedSquares = [];
let isQuantumMode = false;
let timerInterval = null;

function getPieceHTML(type, color) {
    const c = (color === 'white') ? 'cyan' : '#f40';
    let shapes = '';
    
    if (type === 'p') shapes = `<div style="width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:20px solid ${c};"></div>`;
    else if (type === 'r') shapes = `<div style="width:20px;height:20px;background:${c};"></div>`;
    else if (type === 'n') shapes = `<div style="width:10px;height:20px;background:${c};transform:skew(-20deg);"></div>`;
    else if (type === 'b') shapes = `<div style="width:15px;height:15px;background:${c};transform:rotate(45deg);"></div>`;
    else if (type === 'q') shapes = `<div style="width:20px;height:20px;border-radius:50%;border:2px solid ${c};"></div>`;
    else if (type === 'k') shapes = `<div style="width:20px;height:20px;background:${c};clip-path:polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);"></div>`;
    
    return `<div style="filter:drop-shadow(0 0 5px ${c});display:flex;align-items:center;justify-content:center;">${shapes}</div>`;
}

function renderBoard() {
    const boardEl = document.getElementById('quantum-board');
    boardEl.innerHTML = ''; 
    let rRows = (userColor === 'black') ? [...ROWS].reverse() : ROWS;
    let rCols = (userColor === 'black') ? [...COLS].reverse() : COLS;

    rRows.forEach(row => {
        rCols.forEach(col => {
            const id = col + row;
            const sq = document.createElement('div');
            sq.className = 'square';
            sq.id = id;
            sq.classList.add((COLS.indexOf(col)+parseInt(row))%2===0 ? 'sq-dark':'sq-light');

            if (boardData[id]) {
                const p = boardData[id].type || boardData[id];
                const type = p.toLowerCase();
                const color = (p === p.toUpperCase()) ? 'white' : 'black';
                sq.innerHTML = getPieceHTML(type, color);
            }
            sq.onclick = () => handleSquareClick(id);
            boardEl.appendChild(sq);
        });
    });
    document.getElementById('turn-text').innerText = (currentTurn === 'white') ? ">> WHITE TURN" : ">> BLACK TURN";
}

function handleSquareClick(id) {
    if (currentTurn !== userColor) return; 
    const el = document.getElementById(id);
    if (selectedSquares.includes(id)) {
        selectedSquares = selectedSquares.filter(s => s !== id);
        el.classList.remove('sq-sel');
        return;
    }
    const limit = isQuantumMode ? 3 : 2;
    if (selectedSquares.length < limit) {
        selectedSquares.push(id);
        el.classList.add('sq-sel');
    }
    if (selectedSquares.length === limit) {
        let moveStr = "";
        if (!isQuantumMode) moveStr = selectedSquares.join('');
        else moveStr = `${selectedSquares[0]}${selectedSquares[1]}^${selectedSquares[0]}${selectedSquares[2]}`;
        sendMove(moveStr);
    }
}

function clearSelection() {
    document.querySelectorAll('.sq-sel').forEach(e => e.classList.remove('sq-sel'));
    selectedSquares = [];
}

function toggleMode() {
    isQuantumMode = !isQuantumMode;
    document.getElementById('mode-btn').innerText = isQuantumMode ? "MODE: QUANTUM (3)" : "MODE: STANDARD (2)";
    document.getElementById('mode-btn').style.color = isQuantumMode ? "cyan" : "#888";
    clearSelection();
}

async function sendMove(moveStr) {
    clearSelection();
    try {
        const res = await fetch(`/tournament/move/${matchId}`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ move_str: moveStr })
        });
        const data = await res.json();
        if (data.success) {
            boardData = data.board_data;
            p1Time = data.p1_time;
            p2Time = data.p2_time;
            currentTurn = (currentTurn === 'white') ? 'black' : 'white';
            renderBoard();
        } else {
            alert(data.message);
        }
    } catch(e) { console.error(e); }
}

function formatTime(s) {
    const m = Math.floor(s / 60).toString().padStart(2, '0');
    const sc = Math.floor(s % 60).toString().padStart(2, '0');
    return `${m}:${sc}`;
}

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        if (currentTurn === 'white' && p1Time > 0) p1Time -= 1;
        if (currentTurn === 'black' && p2Time > 0) p2Time -= 1;
        
        document.getElementById('digits-white').innerText = formatTime(p1Time);
        document.getElementById('digits-black').innerText = formatTime(p2Time);
        
        document.getElementById('timer-white').style.opacity = currentTurn === 'white' ? '1' : '0.3';
        document.getElementById('timer-black').style.opacity = currentTurn === 'black' ? '1' : '0.3';

        if (p1Time <= 0 || p2Time <= 0) {
            clearInterval(timerInterval);
            alert("TIME OUT!");
        }
    }, 1000);
}

renderBoard();
startTimer();
</script>

<style>
    .dashboard-wrapper { display: grid; grid-template-columns: 450px 1fr; gap: 20px; max-width: 900px; margin: 40px auto; }
    .board-grid { display: grid; grid-template-columns: repeat(8, 1fr); width: 400px; height: 400px; border: 4px solid var(--primary); }
    .square { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .sq-light { background: #1a2a1a; } .sq-dark { background: #000; }
    .sq-sel { background: rgba(0, 255, 255, 0.3) !important; box-shadow: inset 0 0 10px cyan; }
    .panel { background: rgba(0, 15, 0, 0.9); border: 1px solid var(--primary-dim); padding: 15px; margin-bottom: 15px; }
    .timer-box { border: 2px solid; padding: 10px; text-align: center; border-radius: 5px; transition: opacity 0.2s; }
    .digits { font-size: 2rem; font-weight: bold; display: block; color: #fff; font-family: monospace; }
    .label { font-size: 0.7rem; color: #aaa; letter-spacing: 2px; }
    .btn-mode { background: transparent; border: 1px solid var(--primary-dim); color: #888; padding: 10px; width: 100%; cursor: pointer; margin-bottom: 5px; }
    .btn-clear { background: #333; color: white; border: none; padding: 5px; width: 100%; cursor: pointer; }
</style>
{% endblock %}
