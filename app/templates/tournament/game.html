{% extends "base.html" %}

{% block content %}
<div class="quantum-interface">
    
    <div class="board-wrapper">
        <div id="quantum-board" class="board-grid"></div>
        <div class="board-label">QUANTUM MANIFOLD VIEW</div>
    </div>

    <div class="control-deck">
        <div class="status-panel">
            <div class="status-row">
                <span class="label">WHITE:</span> {{ match.player1.username }}
            </div>
            <div class="status-row">
                <span class="label">BLACK:</span> {{ match.player2.username }}
            </div>
            <div class="status-row">
                <span class="label">YOU:</span> <span style="color: #fff; font-weight: bold;">{{ user_color|upper }}</span>
            </div>
        </div>

        <div class="logs" id="logs">
            <div>> Uplink established.</div>
            <div>> Rendering topology...</div>
        </div>

        <div class="input-panel">
            <label>COMMAND SEQUENCE:</label>
            <div class="input-group">
                <input type="text" id="move-input" placeholder="Select squares or type..." autocomplete="off">
                <button onclick="sendMove()" class="btn-action">EXECUTE</button>
            </div>
            
            <div style="background: rgba(0,20,0,0.5); padding: 10px; margin-top: 10px; font-size: 0.7rem; color: #888; border: 1px solid #333;">
                <strong>TACTICAL MANUAL:</strong><br>
                1. <strong>MOVE:</strong> Click Source -> Click Target.<br>
                2. <strong>SPLIT:</strong> Click Source -> Click Target 1 -> Click Target 2.<br>
                3. <strong>MERGE:</strong> Click Source 1 -> Click Source 2 -> Click Target.
            </div>
        </div>
    </div>
</div>

<div id="game-data" 
     data-match-id="{{ match.id }}" 
     data-board='{{ board_data|safe }}' 
     data-user-color="{{ user_color }}">
</div>

<script>
// --- CONFIGURATION ---
const COLS = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
const ROWS = ['8', '7', '6', '5', '4', '3', '2', '1']; 
const PIECE_URL = "https://upload.wikimedia.org/wikipedia/commons/thumb/";
const PIECE_MAP = {
    'r': 'f/ff/Chess_rdt45.svg/80px-Chess_rdt45.svg.png', 'n': 'e/ef/Chess_ndt45.svg/80px-Chess_ndt45.svg.png',
    'b': '9/98/Chess_bdt45.svg/80px-Chess_bdt45.svg.png', 'q': '4/47/Chess_qdt45.svg/80px-Chess_qdt45.svg.png',
    'k': 'f/f0/Chess_kdt45.svg/80px-Chess_kdt45.svg.png', 'p': 'c/c7/Chess_pdt45.svg/80px-Chess_pdt45.svg.png',
    'R': '7/72/Chess_rlt45.svg/80px-Chess_rlt45.svg.png', 'N': '7/70/Chess_nlt45.svg/80px-Chess_nlt45.svg.png',
    'B': 'b/b1/Chess_blt45.svg/80px-Chess_blt45.svg.png', 'Q': '1/15/Chess_qlt45.svg/80px-Chess_qlt45.svg.png',
    'K': '4/42/Chess_klt45.svg/80px-Chess_klt45.svg.png', 'P': '4/45/Chess_plt45.svg/80px-Chess_plt45.svg.png'
};

// --- STATE ---
const gameDataEl = document.getElementById('game-data');
const matchId = gameDataEl.dataset.matchId;
const userColor = gameDataEl.dataset.userColor;
let currentBoardData = JSON.parse(gameDataEl.dataset.board);
let selectedSquares = [];

// --- CORE FUNCTIONS ---
function initGame() { renderBoard(currentBoardData); }

function renderBoard(boardData) {
    const boardEl = document.getElementById('quantum-board');
    boardEl.innerHTML = ''; 

    let renderRows = (userColor === 'black') ? [...ROWS].reverse() : ROWS;
    let renderCols = (userColor === 'black') ? [...COLS].reverse() : COLS;

    renderRows.forEach(row => {
        renderCols.forEach(col => {
            const squareId = col + row;
            const squareEl = document.createElement('div');
            squareEl.className = 'square';
            squareEl.id = squareId;
            squareEl.dataset.coord = squareId;
            
            const isDark = (COLS.indexOf(col) + parseInt(row)) % 2 === 0;
            squareEl.classList.add(isDark ? 'sq-dark' : 'sq-light');

            if (boardData[squareId]) {
                const pieceChar = boardData[squareId];
                const img = document.createElement('img');
                img.src = PIECE_URL + PIECE_MAP[pieceChar];
                img.className = 'piece-img';
                squareEl.appendChild(img);
            }

            squareEl.onclick = () => handleSquareClick(squareId);
            boardEl.appendChild(squareEl);
        });
    });
}

// --- ADVANCED CLICK LOGIC (MERGE/SPLIT/MOVE) ---
function handleSquareClick(coord) {
    const el = document.getElementById(coord);
    const input = document.getElementById('move-input');

    // Deselect if already clicked
    if (selectedSquares.includes(coord)) {
        selectedSquares = selectedSquares.filter(s => s !== coord);
        el.classList.remove('selected');
        input.value = ''; // Clear input if deselecting
        return;
    }

    // Add to selection (Max 3 squares)
    if (selectedSquares.length < 3) {
        selectedSquares.push(coord);
        el.classList.add('selected');
    }

    // --- LOGIC: CONSTRUCT MOVE STRING ---
    if (selectedSquares.length === 2) {
        // CASE A: STANDARD MOVE (S1 -> T)
        input.value = selectedSquares[0] + selectedSquares[1];
    } 
    else if (selectedSquares.length === 3) {
        const s1 = selectedSquares[0];
        const s2 = selectedSquares[1];
        const t  = selectedSquares[2];

        // Check if S1 and S2 are pieces (Check raw data)
        const piece1 = currentBoardData[s1];
        const piece2 = currentBoardData[s2];

        if (piece1 && piece2) {
            // CASE B: MERGE (S1 & S2 -> T)
            // User clicked two pieces, then a target.
            input.value = `${s1}${t}^${s2}${t}`;
        } else {
            // CASE C: SPLIT (S1 -> T1 & T2)
            // User clicked one piece, then two targets.
            // Assumption: s1 is source, s2 and t are targets
            input.value = `${s1}${s2}^${s1}${t}`;
        }
    }
}

async function sendMove() {
    const input = document.getElementById('move-input');
    const moveStr = input.value;
    const logEl = document.getElementById('logs');

    if (!moveStr) return;

    logEl.innerHTML += `<div>> Executing: ${moveStr}...</div>`;
    logEl.scrollTop = logEl.scrollHeight;
    
    try {
        const response = await fetch(`/tournament/move/${matchId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ move_str: moveStr })
        });
        const res = await response.json();

        if (res.success) {
            logEl.innerHTML += `<div style="color: #0f0;">> MOVE SUCCESS.</div>`;
            currentBoardData = res.board_data;
            
            // Clear selections
            document.querySelectorAll('.selected').forEach(e => e.classList.remove('selected'));
            selectedSquares = [];
            input.value = '';
            
            renderBoard(currentBoardData);
        } else {
            logEl.innerHTML += `<div style="color: #f00;">> ERROR: ${res.message}</div>`;
        }
    } catch (e) {
        logEl.innerHTML += `<div style="color: #f00;">> SIGNAL LOST.</div>`;
    }
}

initGame();
</script>

<style>
    /* LAYOUT */
    .quantum-interface {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 30px;
        margin-top: 30px;
        padding: 20px;
    }

    /* BOARD */
    .board-wrapper {
        border: 2px solid var(--primary-dim);
        padding: 10px;
        background: rgba(0, 10, 0, 0.8);
        box-shadow: 0 0 30px rgba(0, 255, 65, 0.1);
    }

    .board-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        width: 400px;
        height: 400px;
        border: 4px solid var(--primary);
    }

    .square {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: crosshair;
        position: relative;
    }

    .sq-light { background-color: #1a2a1a; }
    .sq-dark { background-color: #000000; }

    .selected {
        box-shadow: inset 0 0 20px var(--primary);
        background-color: rgba(0, 255, 65, 0.2);
    }

    /* PIECES */
    .piece-img {
        width: 85%;
        height: 85%;
        filter: sepia(1) saturate(10) hue-rotate(90deg) brightness(1.2) drop-shadow(0 0 5px var(--primary));
        pointer-events: none;
        transition: transform 0.2s;
    }

    .board-label {
        text-align: center;
        margin-top: 10px;
        color: var(--primary-dim);
        font-size: 0.8rem;
        letter-spacing: 2px;
    }

    /* CONTROLS */
    .control-deck {
        width: 350px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .status-panel {
        border: 1px solid var(--primary);
        padding: 15px;
        background: rgba(0, 20, 0, 0.6);
    }

    .status-row {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px dashed var(--primary-dim);
        padding-bottom: 5px;
        margin-bottom: 5px;
    }

    .logs {
        height: 150px;
        background: #000;
        border: 1px solid var(--primary-dim);
        overflow-y: auto;
        padding: 10px;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        color: var(--primary);
    }

    .input-group {
        display: flex;
        gap: 10px;
    }

    .btn-action {
        border: 1px solid var(--primary);
        background: var(--primary-dim);
        color: black;
        font-weight: bold;
        cursor: pointer;
    }
    .btn-action:hover {
        background: var(--primary);
        box-shadow: 0 0 15px var(--primary);
    }
</style>
{% endblock %}
