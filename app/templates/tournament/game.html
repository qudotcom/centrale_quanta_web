{% extends "base.html" %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="board-column">
        <div class="board-frame"><div id="quantum-board" class="board-grid"></div></div>
    </div>
    <div class="hud-column">
        <div class="panel turn-panel">
            <div class="panel-header">>> QUANTUM STATE</div>
            <div id="turn-display" class="turn-box"></div>
        </div>
        <div id="radar-popup" style="display:none; position:absolute; z-index:100; background:black; border:1px solid cyan; padding:10px;">
            <div style="color:cyan; font-size:0.8rem; margin-bottom:5px;">PHASE RADAR</div>
            <div id="radar-visual" style="width:50px; height:50px; border-radius:50%; border:2px solid #333; position:relative;">
                <div id="radar-needle" style="width:50%; height:2px; background:cyan; position:absolute; top:50%; left:50%; transform-origin:left;"></div>
            </div>
            <div id="radar-text" style="color:#fff; font-size:0.7rem; text-align:center;">0°</div>
        </div>
    </div>
</div>

<div id="game-data" data-match-id="{{ match.id }}" data-board='{{ board_data|safe }}' data-user-color="{{ user_color }}" data-turn="{{ current_turn }}"></div>

<script>
// (Keep CONSTANTS PIECE_URL, PIECE_MAP same)
const PIECE_URL = "https://upload.wikimedia.org/wikipedia/commons/thumb/";
const PIECE_MAP = {
    'r':'f/ff/Chess_rdt45.svg/80px-Chess_rdt45.svg.png', 'n':'e/ef/Chess_ndt45.svg/80px-Chess_ndt45.svg.png',
    'b':'9/98/Chess_bdt45.svg/80px-Chess_bdt45.svg.png', 'q':'4/47/Chess_qdt45.svg/80px-Chess_qdt45.svg.png',
    'k':'f/f0/Chess_kdt45.svg/80px-Chess_kdt45.svg.png', 'p':'c/c7/Chess_pdt45.svg/80px-Chess_pdt45.svg.png',
    'R':'7/72/Chess_rlt45.svg/80px-Chess_rlt45.svg.png', 'N':'7/70/Chess_nlt45.svg/80px-Chess_nlt45.svg.png',
    'B':'b/b1/Chess_blt45.svg/80px-Chess_blt45.svg.png', 'Q':'1/15/Chess_qlt45.svg/80px-Chess_qlt45.svg.png',
    'K':'4/42/Chess_klt45.svg/80px-Chess_klt45.svg.png', 'P':'4/45/Chess_plt45.svg/80px-Chess_plt45.svg.png'
};
// ... (Keep other constants)

function renderBoard(boardData) {
    const boardEl = document.getElementById('quantum-board');
    boardEl.innerHTML = ''; 
    const COLS = ['a','b','c','d','e','f','g','h'];
    const ROWS = ['8','7','6','5','4','3','2','1'];
    let rRows = (userColor === 'black') ? [...ROWS].reverse() : ROWS;
    let rCols = (userColor === 'black') ? [...COLS].reverse() : COLS;

    rRows.forEach(row => {
        rCols.forEach(col => {
            const id = col + row;
            const sq = document.createElement('div');
            sq.className = 'square';
            sq.id = id;
            sq.classList.add((COLS.indexOf(col)+parseInt(row))%2===0 ? 'sq-dark':'sq-light');

            if (boardData[id]) {
                const data = boardData[id]; // Now an Object: {type, prob, entangle_color, phase}
                const p = data.type;
                
                const img = document.createElement('img');
                img.src = PIECE_URL + PIECE_MAP[p];
                img.className = 'piece-img ' + (p===p.toUpperCase() ? 'filter-white':'filter-black');
                
                // 1. VISUAL NOVELTY: OPACITY FOR PROBABILITY
                if (data.prob < 1.0) {
                    img.style.opacity = "0.5";
                }

                // 2. VISUAL NOVELTY: ENTANGLEMENT RINGS
                if (data.entangle_color) {
                    const ring = document.createElement('div');
                    ring.className = 'entangle-ring';
                    ring.style.borderColor = data.entangle_color;
                    sq.appendChild(ring);
                }

                // 3. RIGHT CLICK FOR PHASE RADAR
                sq.oncontextmenu = (e) => {
                    e.preventDefault();
                    showRadar(e.pageX, e.pageY, data.phase);
                };

                sq.appendChild(img);
            }
            sq.onclick = () => handleSquareClick(id);
            boardEl.appendChild(sq);
        });
    });
}

function showRadar(x, y, phase) {
    const popup = document.getElementById('radar-popup');
    popup.style.display = 'block';
    popup.style.left = x + 'px';
    popup.style.top = y + 'px';
    
    // Rotate Needle
    document.getElementById('radar-needle').style.transform = `rotate(${phase}deg)`;
    document.getElementById('radar-text').innerText = phase + "°";
    
    // Hide on click elsewhere
    setTimeout(() => {
        document.addEventListener('click', () => { popup.style.display = 'none'; }, {once:true});
    }, 100);
}

// (Keep handleSquareClick, sendMove logic same as before, just ensure they parse boardData correctly)
// ...
</script>

<style>
    /* (Previous styles) */
    .entangle-ring {
        position: absolute;
        width: 90%; height: 90%;
        border-radius: 50%;
        border: 3px dashed; /* Color set by JS */
        animation: spin 10s linear infinite;
        pointer-events: none;
    }
    
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    /* Ensure opacity transition */
    .piece-img { transition: opacity 0.3s; }
</style>
{% endblock %}
