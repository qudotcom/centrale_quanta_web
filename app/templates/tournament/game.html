{% extends "base.html" %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="board-column">
        <div class="board-frame">
            <div id="quantum-board" class="board-grid"></div>
        </div>
    </div>

    <div class="hud-column">
        <div class="panel turn-panel">
            <div class="panel-header">>> CHRONOMETER</div>
            <div class="timer-row">
                <div class="timer-box" id="timer-white" style="border-color: #0ff;">
                    <div class="label">WHITE</div>
                    <div class="digits" id="digits-white">10:00</div>
                </div>
                <div class="timer-box" id="timer-black" style="border-color: #f70;">
                    <div class="label">BLACK</div>
                    <div class="digits" id="digits-black">10:00</div>
                </div>
            </div>
            <div id="turn-display" class="turn-status">INITIALIZING...</div>
        </div>

        <div class="panel info-panel">
            <div class="info-row"><span>WHITE:</span> {{ match.player1.username }}</div>
            <div class="info-row"><span>BLACK:</span> {{ match.player2.username }}</div>
            <div class="info-row"><span>YOU:</span> <strong style="color:white">{{ user_color|upper }}</strong></div>
        </div>

        <div class="panel control-panel">
            <div class="panel-header">>> INTERFACE MODE</div>
            <div class="mode-switch-container">
                <span id="mode-text" style="color: #888; font-size: 0.8rem;">STANDARD (Swipe/Drag)</span>
                <label class="switch">
                    <input type="checkbox" id="quantum-toggle" onclick="toggleMode()">
                    <span class="slider round"></span>
                </label>
            </div>
            <div id="instruction-text" class="instruction-box">
                Drag pieces to move.
            </div>
            <div style="margin-top:10px;">
                <button onclick="clearSelection()" class="btn-action">RESET SELECTION</button>
            </div>
        </div>

        <div class="panel logs-panel" id="logs">
            <div class="log-entry">> Uplink Established.</div>
        </div>
    </div>
</div>

<div id="game-data" 
     data-match-id="{{ match.id }}" 
     data-board='{{ board_data|safe }}' 
     data-user-color="{{ user_color }}"
     data-turn="{{ current_turn }}"
     data-p1="{{ p1_time }}"
     data-p2="{{ p2_time }}">
</div>

<script>
// --- CYBERPUNK CHESS PIECES (SVG) ---
const SVGS = {
    'P': '<svg viewBox="0 0 100 100"><path d="M50 15 L80 85 L20 85 Z" fill="currentColor"/><circle cx="50" cy="35" r="10" fill="#000"/></svg>', // Triangle with eye
    'R': '<svg viewBox="0 0 100 100"><path d="M20 20 L40 20 L40 35 L60 35 L60 20 L80 20 L80 85 L20 85 Z" fill="currentColor"/><rect x="30" y="50" width="40" height="5" fill="#000"/></svg>', // Tower
    'N': '<svg viewBox="0 0 100 100"><path d="M25 85 L75 85 L65 35 L75 25 L55 15 L25 35 L35 55 Z" fill="currentColor"/><circle cx="45" cy="35" r="5" fill="#000"/></svg>', // Angular Horse
    'B': '<svg viewBox="0 0 100 100"><path d="M50 10 L80 50 L50 90 L20 50 Z" fill="currentColor"/><rect x="45" y="25" width="10" height="50" fill="#000"/></svg>', // Obelisk
    'Q': '<svg viewBox="0 0 100 100"><path d="M15 85 L25 35 L40 55 L50 15 L60 55 L75 35 L85 85 Z" fill="currentColor"/><circle cx="50" cy="85" r="5" fill="#000"/></svg>', // Spike Crown
    'K': '<svg viewBox="0 0 100 100"><rect x="35" y="15" width="30" height="70" fill="currentColor"/><path d="M35 15 L50 0 L65 15 Z" fill="currentColor"/><rect x="25" y="75" width="50" height="10" fill="currentColor"/></svg>' // Monolith (No Cross)
};
const PIECE_MAP = { ...SVGS, 'p':SVGS.P, 'r':SVGS.R, 'n':SVGS.N, 'b':SVGS.B, 'q':SVGS.Q, 'k':SVGS.K };

const COLS = ['a','b','c','d','e','f','g','h'];
const ROWS = ['8','7','6','5','4','3','2','1'];
const gameData = document.getElementById('game-data');
const matchId = gameData.dataset.matchId;
const userColor = gameData.dataset.userColor;
let currentTurn = gameData.dataset.turn;
let boardData = JSON.parse(gameData.dataset.board);
let p1Time = parseFloat(gameData.dataset.p1);
let p2Time = parseFloat(gameData.dataset.p2);
let selectedSquares = [];
let isQuantumMode = false;
let draggedId = null;
let timerInterval = null;

function renderBoard() {
    const boardEl = document.getElementById('quantum-board');
    boardEl.innerHTML = ''; 
    let rRows = (userColor === 'black') ? [...ROWS].reverse() : ROWS;
    let rCols = (userColor === 'black') ? [...COLS].reverse() : COLS;

    rRows.forEach(row => {
        rCols.forEach(col => {
            const id = col + row;
            const sq = document.createElement('div');
            sq.className = 'square';
            sq.id = id;
            sq.classList.add((COLS.indexOf(col)+parseInt(row))%2===0 ? 'sq-dark':'sq-light');

            // --- DROP ZONE ---
            sq.ondragover = (e) => e.preventDefault();
            sq.ondrop = (e) => handleDrop(e, id);
            sq.onclick = () => handleClick(id);

            if (boardData[id]) {
                const data = boardData[id];
                const p = data.type || data;
                const colorClass = (p === p.toUpperCase()) ? 'piece-white' : 'piece-black';
                
                const pieceWrap = document.createElement('div');
                pieceWrap.className = `piece-wrapper ${colorClass}`;
                pieceWrap.innerHTML = PIECE_MAP[p];
                
                if(data.prob && data.prob < 1.0) pieceWrap.style.opacity = "0.6";

                // --- DRAG SOURCE ---
                if (!isQuantumMode && currentTurn === userColor) {
                    pieceWrap.draggable = true;
                    pieceWrap.ondragstart = (e) => {
                        draggedId = id;
                        e.dataTransfer.effectAllowed = 'move';
                    };
                }
                sq.appendChild(pieceWrap);
            }
            boardEl.appendChild(sq);
        });
    });
    
    // Update HUD
    const turnEl = document.getElementById('turn-display');
    turnEl.innerText = (currentTurn === 'white') ? "■ WHITE TURN" : "■ BLACK TURN";
    turnEl.style.color = (currentTurn === 'white') ? "#0ff" : "#f70";
}

// --- STANDARD MODE (SWIPE/DRAG) ---
function handleDrop(e, targetId) {
    if (isQuantumMode || !draggedId || draggedId === targetId) return;
    e.preventDefault();
    const moveStr = draggedId + targetId;
    sendMove(moveStr);
    draggedId = null;
}

// --- QUANTUM MODE (CLICK) ---
function handleClick(id) {
    if (currentTurn !== userColor) return;
    
    if (selectedSquares.includes(id)) {
        clearSelection();
        return;
    }

    const limit = isQuantumMode ? 3 : 2;
    if (selectedSquares.length < limit) {
        selectedSquares.push(id);
        const el = document.getElementById(id);
        if(selectedSquares.length===1) el.classList.add('sq-sel-src');
        else el.classList.add('sq-sel-tgt');
    }

    if (!isQuantumMode && selectedSquares.length === 2) {
        // Fallback for tap-to-move in Standard mode
        sendMove(selectedSquares.join(''));
    } else if (isQuantumMode && selectedSquares.length === 3) {
        const s1 = selectedSquares[0];
        const s2 = selectedSquares[1];
        const t = selectedSquares[2];
        // Heuristic: If s2 occupied -> Merge (Src1 Src2 Tgt)
        // If s2 empty -> Split (Src Tgt1 Tgt2)
        const isS2Occupied = boardData[s2] !== undefined;
        let moveStr = isS2Occupied ? `${s1}${t}^${s2}${t}` : `${s1}${s2}^${s1}${t}`;
        sendMove(moveStr);
    }
}

function clearSelection() {
    selectedSquares = [];
    document.querySelectorAll('.square').forEach(e => e.classList.remove('sq-sel-src','sq-sel-tgt'));
}

function toggleMode() {
    isQuantumMode = !isQuantumMode;
    const txt = document.getElementById('mode-text');
    const instr = document.getElementById('instruction-text');
    if (isQuantumMode) {
        txt.innerText = "QUANTUM (3 Clicks)";
        txt.style.color = "cyan";
        instr.innerHTML = "<strong>QUANTUM:</strong><br>Split: [Src] [Tgt1] [Tgt2]<br>Merge: [Src1] [Src2] [Tgt]";
    } else {
        txt.innerText = "STANDARD (Swipe)";
        txt.style.color = "#888";
        instr.innerText = "Drag pieces to move.";
    }
    clearSelection();
    renderBoard(); // Re-render to update draggable status
}

async function sendMove(moveStr) {
    clearSelection();
    log(`Sending: ${moveStr}...`);
    try {
        const res = await fetch(`/tournament/move/${matchId}`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ move_str: moveStr })
        });
        const data = await res.json();
        if (data.success) {
            log("Move Accepted.", "#0f0");
            boardData = data.board_data;
            p1Time = data.p1_time; p2Time = data.p2_time;
            currentTurn = (currentTurn === 'white') ? 'black' : 'white';
            renderBoard();
            if(data.game_over) alert("GAME OVER: " + data.winner);
        } else {
            log("Error: " + data.message, "#f44");
        }
    } catch(e) { log("Connection Error", "#f44"); }
}

function log(msg, color="#aaa") {
    const b = document.getElementById('logs');
    b.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
    b.scrollTop = b.scrollHeight;
}

function formatTime(s) {
    const m = Math.floor(s/60).toString().padStart(2,'0');
    const sec = Math.floor(s%60).toString().padStart(2,'0');
    return `${m}:${sec}`;
}

function startTimer() {
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
        if(currentTurn==='white' && p1Time>0) p1Time--;
        if(currentTurn==='black' && p2Time>0) p2Time--;
        document.getElementById('digits-white').innerText = formatTime(p1Time);
        document.getElementById('digits-black').innerText = formatTime(p2Time);
        document.getElementById('timer-white').style.boxShadow = (currentTurn==='white')?"0 0 15px cyan":"none";
        document.getElementById('timer-black').style.boxShadow = (currentTurn==='black')?"0 0 15px #f70":"none";
    }, 1000);
}

renderBoard();
startTimer();
</script>

<style>
    /* LAYOUT */
    .dashboard-wrapper { display: grid; grid-template-columns: 500px 1fr; gap: 30px; max-width: 1000px; margin: 40px auto; }
    
    /* BOARD */
    .board-frame { border: 4px solid var(--primary-dim); padding: 5px; background: #000; box-shadow: 0 0 30px rgba(0,255,65,0.1); }
    .board-grid { display: grid; grid-template-columns: repeat(8, 1fr); width: 480px; height: 480px; }
    .square { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
    .sq-light { background: #111; } .sq-dark { background: #000; }
    
    /* SELECTION */
    .sq-sel-src { background: rgba(0, 255, 255, 0.25) !important; box-shadow: inset 0 0 15px cyan; }
    .sq-sel-tgt { background: rgba(0, 255, 0, 0.25) !important; box-shadow: inset 0 0 15px lime; }

    /* PIECES */
    .piece-wrapper { width: 85%; height: 85%; transition: transform 0.1s; cursor: grab; }
    .piece-wrapper:active { transform: scale(1.1); cursor: grabbing; }
    .piece-white { color: cyan; filter: drop-shadow(0 0 5px cyan); }
    .piece-black { color: #ff4400; filter: drop-shadow(0 0 5px #ff4400); }

    /* HUD */
    .panel { background: rgba(0, 15, 0, 0.9); border: 1px solid var(--primary-dim); padding: 15px; margin-bottom: 15px; }
    .panel-header { border-bottom: 1px solid var(--primary-dim); margin-bottom: 10px; font-size: 0.8rem; color: var(--primary); letter-spacing: 2px; }
    .timer-row { display: flex; justify-content: space-between; gap: 10px; }
    .timer-box { border: 2px solid; padding: 10px; text-align: center; border-radius: 5px; width: 48%; transition: box-shadow 0.3s; }
    .digits { font-size: 1.8rem; font-family: monospace; color: #fff; font-weight: bold; }
    .label { font-size: 0.7rem; color: #aaa; }
    .turn-status { text-align: center; margin-top: 10px; font-weight: bold; letter-spacing: 1px; font-size: 1.1rem; }
    .logs-panel { height: 150px; overflow-y: auto; background: #000; font-family: monospace; font-size: 0.8rem; color: var(--primary); }
    .instruction-box { background: rgba(255,255,255,0.05); padding: 10px; font-size: 0.8rem; color: #ccc; margin-top: 10px; border-left: 3px solid var(--primary); }
    
    /* SWITCH */
    .mode-switch-container { display: flex; align-items: center; justify-content: space-between; }
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border: 1px solid #555; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 3px; background-color: #888; transition: .4s; }
    input:checked + .slider { background-color: rgba(0, 255, 255, 0.3); border-color: cyan; }
    input:checked + .slider:before { transform: translateX(26px); background-color: cyan; box-shadow: 0 0 10px cyan; }
    .slider.round { border-radius: 24px; } .slider.round:before { border-radius: 50%; }
    .btn-action { background: #333; color: #fff; border: 1px solid #666; padding: 5px 10px; cursor: pointer; width: 100%; }
    .btn-action:hover { background: #444; border-color: #fff; }
</style>
{% endblock %}
