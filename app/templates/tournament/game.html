{% extends "base.html" %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="board-column">
        <div class="board-frame">
            <div id="quantum-board" class="board-grid"></div>
        </div>
    </div>

    <div class="hud-column">
        
        <div class="panel turn-panel">
            <div class="panel-header">>> CHRONOMETER</div>
            
            <div id="signal-box" style="margin-bottom: 10px; padding: 10px; text-align: center; border: 1px solid #333; background: #000;">
                <div id="turn-display" class="turn-status">INITIALIZING...</div>
                <div id="ai-loader" class="blink" style="display: none; color: #0f0; margin-top:5px;">AI THINKING...</div>
            </div>

            <div class="timer-row">
                <div class="timer-box" id="timer-white" style="border-color: #0ff;">
                    <div class="label">WHITE</div><div class="digits" id="digits-white">10:00</div>
                </div>
                <div class="timer-box" id="timer-black" style="border-color: #f70;">
                    <div class="label">BLACK</div><div class="digits" id="digits-black">10:00</div>
                </div>
            </div>
        </div>

        <div class="panel info-panel">
            <div class="info-row"><span>YOU:</span> <strong style="color:white">{{ user_color|upper }}</strong></div>
            <div class="info-row" style="margin-top:5px; border-top:1px dashed #444; padding-top:5px;">
                <span>MODE:</span> <span style="color:cyan">{{ difficulty_name|default('SUPERPOSITION')|upper }}</span>
            </div>
        </div>

        <div class="panel control-panel">
            <div class="panel-header">>> INTERFACE</div>
            <div class="mode-switch-container">
                <span id="mode-text" style="color: #888;">STANDARD (Swipe)</span>
                <label class="switch">
                    <input type="checkbox" id="quantum-toggle" onclick="toggleMode()">
                    <span class="slider round"></span>
                </label>
            </div>
            <button onclick="clearSelection()" class="btn-action" style="margin-top:10px;">RESET SELECTION</button>
        </div>
        
        <div class="panel logs-panel" id="logs"><div class="log-entry">> Connected.</div></div>
        
        <div id="radar-popup" style="display:none; position:absolute; z-index:100; background:rgba(0,0,0,0.9); border:1px solid cyan; padding:10px;">
            <div style="color:cyan; font-size:0.7rem; margin-bottom:5px;">PHASE RADAR</div>
            <div style="width:60px; height:60px; border-radius:50%; border:1px solid #555; position:relative;">
                <div id="radar-needle" style="width:50%; height:2px; background:cyan; position:absolute; top:50%; left:50%; transform-origin:left;"></div>
            </div>
            <div id="radar-text" style="color:#fff; font-size:0.7rem; text-align:center; margin-top:5px;">0°</div>
        </div>
    </div>
</div>

<div id="game-data" data-match-id="{{ match.id }}" data-board='{{ board_data|safe }}' data-user-color="{{ user_color }}" data-turn="{{ current_turn }}" data-p1="{{ p1_time }}" data-p2="{{ p2_time }}"></div>

<script>
// ASSETS
const SVGS = {
    'P': '<svg viewBox="0 0 100 100"><path d="M50 15 L80 85 L20 85 Z" fill="currentColor"/><rect x="42" y="30" width="16" height="30" fill="#000"/><circle cx="50" cy="45" r="4" fill="currentColor"/></svg>',
    'R': '<svg viewBox="0 0 100 100"><path d="M20 20 L40 20 L40 35 L60 35 L60 20 L80 20 L80 85 L20 85 Z" fill="currentColor"/><rect x="30" y="50" width="40" height="5" fill="#000"/></svg>',
    'N': '<svg viewBox="0 0 100 100"><path d="M25 85 L75 85 L65 35 L75 25 L55 15 L25 35 L35 55 Z" fill="currentColor"/><circle cx="45" cy="35" r="5" fill="#000"/></svg>',
    'B': '<svg viewBox="0 0 100 100"><path d="M50 10 L80 50 L50 90 L20 50 Z" fill="currentColor"/><rect x="45" y="25" width="10" height="50" fill="#000"/></svg>',
    'Q': '<svg viewBox="0 0 100 100"><path d="M15 85 L25 35 L40 55 L50 15 L60 55 L75 35 L85 85 Z" fill="currentColor"/><circle cx="50" cy="85" r="5" fill="#000"/></svg>',
    'K': '<svg viewBox="0 0 100 100"><rect x="35" y="15" width="30" height="70" fill="currentColor"/><path d="M35 15 L50 0 L65 15 Z" fill="currentColor"/><rect x="25" y="75" width="50" height="10" fill="currentColor"/></svg>'
};
const PIECE_MAP = { ...SVGS, 'p':SVGS.P, 'r':SVGS.R, 'n':SVGS.N, 'b':SVGS.B, 'q':SVGS.Q, 'k':SVGS.K };
const COLS = ['a','b','c','d','e','f','g','h'];
const ROWS = ['8','7','6','5','4','3','2','1'];
const gameData = document.getElementById('game-data');
const matchId = gameData.dataset.matchId;
const userColor = gameData.dataset.userColor;

let currentTurn = gameData.dataset.turn;
let boardData = JSON.parse(gameData.dataset.board);
let p1Time = parseFloat(gameData.dataset.p1) || 600.0;
let p2Time = parseFloat(gameData.dataset.p2) || 600.0;
let selectedSquares = [];
let isQuantumMode = false;
let draggedId = null;
let timerInterval = null;

function renderBoard() {
    const boardEl = document.getElementById('quantum-board');
    boardEl.innerHTML = ''; 
    let rRows = (userColor === 'black') ? [...ROWS].reverse() : ROWS;
    let rCols = (userColor === 'black') ? [...COLS].reverse() : COLS;

    rRows.forEach(row => {
        rCols.forEach(col => {
            const id = col + row;
            const sq = document.createElement('div');
            sq.className = 'square';
            sq.id = id;
            sq.classList.add((COLS.indexOf(col)+parseInt(row))%2===0 ? 'sq-dark':'sq-light');

            sq.ondragover = (e) => e.preventDefault();
            sq.ondrop = (e) => handleDrop(e, id);
            sq.onclick = () => handleClick(id);
            sq.oncontextmenu = (e) => {
                if(boardData[id]) { e.preventDefault(); showRadar(e.pageX, e.pageY, boardData[id].phase); }
            };

            if (boardData[id]) {
                const data = boardData[id];
                const p = data.type || data;
                const colorClass = (p === p.toUpperCase()) ? 'piece-white' : 'piece-black';
                const pieceWrap = document.createElement('div');
                pieceWrap.className = `piece-wrapper ${colorClass}`;
                pieceWrap.innerHTML = PIECE_MAP[p];
                
                if(data.prob && data.prob < 0.99) pieceWrap.classList.add('quantum-ghost');
                
                if(data.entangle_color) {
                    const ring = document.createElement('div');
                    ring.className = 'entangle-ring';
                    ring.style.borderColor = data.entangle_color;
                    sq.appendChild(ring);
                }

                if (!isQuantumMode && currentTurn === userColor) {
                    pieceWrap.draggable = true;
                    pieceWrap.ondragstart = (e) => { draggedId = id; e.dataTransfer.effectAllowed = 'move'; };
                }
                sq.appendChild(pieceWrap);
            }
            boardEl.appendChild(sq);
        });
    });
    
    // ROBUST TURN INDICATOR
    const turnEl = document.getElementById('turn-display');
    const signalBox = document.getElementById('signal-box');
    
    if (currentTurn === 'white') {
        turnEl.innerText = "■ WHITE TO MOVE";
        turnEl.style.color = "#0ff";
        signalBox.style.borderColor = (userColor === 'white') ? "#0ff" : "#333";
    } else {
        turnEl.innerText = "■ BLACK TO MOVE";
        turnEl.style.color = "#f70";
        signalBox.style.borderColor = (userColor === 'black') ? "#f70" : "#333";
    }
}

function showRadar(x, y, phase) {
    const popup = document.getElementById('radar-popup');
    popup.style.display = 'block';
    popup.style.left = x + 'px'; popup.style.top = y + 'px';
    document.getElementById('radar-needle').style.transform = `rotate(${-phase}deg)`;
    document.getElementById('radar-text').innerText = phase + "°";
    setTimeout(() => { document.addEventListener('click', () => { popup.style.display = 'none'; }, {once:true}); }, 100);
}

function handleDrop(e, targetId) {
    if (isQuantumMode || !draggedId || draggedId === targetId) return;
    e.preventDefault();
    sendMove(draggedId + targetId);
    draggedId = null;
}

function handleClick(id) {
    if (currentTurn !== userColor) return;
    if (selectedSquares.includes(id)) { clearSelection(); return; }
    
    const limit = isQuantumMode ? 3 : 2;
    if (selectedSquares.length < limit) {
        selectedSquares.push(id);
        const el = document.getElementById(id);
        if(selectedSquares.length===1) el.classList.add('sq-sel-src'); else el.classList.add('sq-sel-tgt');
    }

    if (!isQuantumMode && selectedSquares.length === 2) {
        sendMove(selectedSquares.join(''));
    } else if (isQuantumMode && selectedSquares.length === 3) {
        const s1 = selectedSquares[0];
        const s2 = selectedSquares[1];
        const t = selectedSquares[2];
        const isS2Occupied = boardData[s2] !== undefined;
        let moveStr = isS2Occupied ? `${s1}${t}^${s2}${t}` : `${s1}${s2}^${s1}${t}`;
        sendMove(moveStr);
    }
}

function clearSelection() {
    selectedSquares = [];
    document.querySelectorAll('.square').forEach(e => e.classList.remove('sq-sel-src','sq-sel-tgt'));
}

function toggleMode() {
    isQuantumMode = !isQuantumMode;
    const txt = document.getElementById('mode-text');
    if (isQuantumMode) { txt.innerText = "QUANTUM (3 Clicks)"; txt.style.color = "cyan"; } 
    else { txt.innerText = "STANDARD (Swipe)"; txt.style.color = "#888"; }
    clearSelection();
    renderBoard();
}

async function sendMove(moveStr) {
    clearSelection();
    log(`Sending: ${moveStr}...`);
    document.getElementById('quantum-board').style.opacity = "0.7";
    document.getElementById('ai-loader').style.display = "block";
    
    try {
        const res = await fetch(`/tournament/move/${matchId}`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ move_str: moveStr })
        });
        const data = await res.json();
        
        document.getElementById('quantum-board').style.opacity = "1.0";
        document.getElementById('ai-loader').style.display = "none";
        
        if (data.success) {
            log("Move Accepted.", "#0f0");
            boardData = data.board_data;
            p1Time = parseFloat(data.p1_time) || p1Time;
            p2Time = parseFloat(data.p2_time) || p2Time;
            
            // FIX: Rely ONLY on Server Truth
            currentTurn = data.current_turn;
            
            renderBoard();
            if(data.ai_moved) log("AI Executed Counter-Move.", "#f70");
            if(data.game_over) alert("GAME OVER: " + data.winner.toUpperCase() + " WINS!");
        } else {
            log("Error: " + data.message, "#f44");
        }
    } catch(e) { document.getElementById('quantum-board').style.opacity = "1.0"; log("Connection Error", "#f44"); }
}

function log(msg, color="#aaa") {
    const b = document.getElementById('logs');
    b.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
    b.scrollTop = b.scrollHeight;
}

function formatTime(s) {
    if (isNaN(s) || s === null) return "10:00";
    if (s < 0) s = 0;
    const m = Math.floor(s/60).toString().padStart(2,'0');
    const sec = Math.floor(s%60).toString().padStart(2,'0');
    return `${m}:${sec}`;
}

function startTimer() {
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
        if(currentTurn==='white' && p1Time>0) p1Time--;
        if(currentTurn==='black' && p2Time>0) p2Time--;
        document.getElementById('digits-white').innerText = formatTime(p1Time);
        document.getElementById('digits-black').innerText = formatTime(p2Time);
        document.getElementById('timer-white').style.boxShadow = (currentTurn==='white')?"0 0 15px cyan":"none";
        document.getElementById('timer-black').style.boxShadow = (currentTurn==='black')?"0 0 15px #f70":"none";
        if(p1Time<=0 || p2Time<=0) { clearInterval(timerInterval); alert("TIME OUT"); }
    }, 1000);
}

renderBoard();
startTimer();
</script>

<style>
    /* LAYOUT */
    .dashboard-wrapper { display: grid; grid-template-columns: 500px 1fr; gap: 30px; max-width: 1000px; margin: 40px auto; padding: 0 20px; }
    .board-frame { border: 4px solid var(--primary-dim); padding: 5px; background: #000; box-shadow: 0 0 30px rgba(0,255,65,0.1); }
    .board-grid { display: grid; grid-template-columns: repeat(8, 1fr); width: 480px; height: 480px; }
    .square { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
    .sq-light { background: #111; } .sq-dark { background: #000; }
    .sq-sel-src { background: rgba(0, 255, 255, 0.25) !important; box-shadow: inset 0 0 15px cyan; }
    .sq-sel-tgt { background: rgba(0, 255, 0, 0.25) !important; box-shadow: inset 0 0 15px lime; }

    /* PIECES */
    .piece-wrapper { width: 85%; height: 85%; transition: transform 0.1s; cursor: grab; position: relative; }
    .piece-wrapper:active { transform: scale(1.1); cursor: grabbing; }
    .piece-white { color: cyan; filter: drop-shadow(0 0 5px cyan); }
    .piece-black { color: #ff4400; filter: drop-shadow(0 0 5px #ff4400); }
    
    .quantum-ghost {
        opacity: 0.6;
        border: 2px dotted rgba(255,255,255,0.5);
        border-radius: 50%;
        animation: ghostPulse 1.5s infinite alternate;
        mix-blend-mode: screen;
    }
    .entangle-ring {
        position: absolute; width: 90%; height: 90%; border-radius: 50%;
        border: 3px dashed; animation: spin 10s linear infinite; pointer-events: none;
    }
    @keyframes ghostPulse { 0% { opacity: 0.4; } 100% { opacity: 0.8; box-shadow: 0 0 15px currentColor; } }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* HUD */
    .panel { background: rgba(0, 15, 0, 0.9); border: 1px solid var(--primary-dim); padding: 15px; margin-bottom: 15px; }
    .panel-header { border-bottom: 1px solid var(--primary-dim); margin-bottom: 10px; font-size: 0.8rem; color: var(--primary); letter-spacing: 2px; }
    .timer-row { display: flex; justify-content: space-between; gap: 10px; }
    .timer-box { border: 2px solid; padding: 10px; text-align: center; border-radius: 5px; width: 48%; transition: box-shadow 0.3s; }
    .digits { font-size: 1.8rem; font-family: monospace; color: #fff; font-weight: bold; }
    .label { font-size: 0.7rem; color: #aaa; }
    .turn-status { text-align: center; font-weight: bold; letter-spacing: 1px; font-size: 1.1rem; }
    .logs-panel { height: 150px; overflow-y: auto; background: #000; font-family: monospace; font-size: 0.8rem; color: var(--primary); }
    .instruction-box { background: rgba(255,255,255,0.05); padding: 10px; font-size: 0.8rem; color: #ccc; margin-top: 10px; border-left: 3px solid var(--primary); }
    
    .mode-switch-container { display: flex; align-items: center; justify-content: space-between; }
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border: 1px solid #555; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 3px; background-color: #888; transition: .4s; }
    input:checked + .slider { background-color: rgba(0, 255, 255, 0.3); border-color: cyan; }
    input:checked + .slider:before { transform: translateX(26px); background-color: cyan; box-shadow: 0 0 10px cyan; }
    .slider.round { border-radius: 24px; } .slider.round:before { border-radius: 50%; }
    .btn-action { background: #333; color: #fff; border: 1px solid #666; padding: 5px 10px; cursor: pointer; width: 100%; }
    .btn-action:hover { background: #444; border-color: #fff; }
    .blink { animation: blink 1s infinite; } @keyframes blink { 50% { opacity: 0; } }
</style>
{% endblock %}
