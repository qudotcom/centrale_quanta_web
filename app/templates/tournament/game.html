{% extends "base.html" %}

{% block content %}
<div class="dashboard-wrapper">
    <div class="board-column">
        <div class="board-frame">
            <div id="quantum-board" class="board-grid"></div>
        </div>
    </div>

    <div class="hud-column">
        <div class="panel turn-panel">
            <div class="panel-header">>> ACTIVE SIGNAL</div>
            <div id="turn-display" class="turn-box">
                {% if current_turn == 'white' %}
                    <span style="color: #0ff;">■ WHITE TO MOVE</span>
                {% else %}
                    <span style="color: #f70;">■ BLACK TO MOVE</span>
                {% endif %}
            </div>
            <div id="ai-loader" style="display: none; color: #0f0; margin-top:10px;" class="blink">AI COMPUTING...</div>
        </div>

        <div class="panel info-panel">
            <div class="info-row"><span>WHITE:</span> {{ match.player1.username }}</div>
            <div class="info-row"><span>BLACK:</span> {{ match.player2.username }}</div>
            <div class="info-row"><span>YOU:</span> <strong style="color:white">{{ user_color|upper }}</strong></div>
        </div>

        <div class="panel kpi-panel">
            <div class="panel-header">PROBABILITY WAVE</div>
            <div class="progress-track"><div id="probability-bar" class="progress-fill" style="width: 50%;"></div></div>
        </div>

        <div class="panel logs-panel" id="logs">
            <div class="log-entry">> Uplink Established.</div>
        </div>

        <div class="panel input-panel">
            <div class="input-wrapper">
                <input type="text" id="move-input" placeholder="Select squares..." disabled>
                <button onclick="clearSelection()" class="btn-clear">X</button>
                <button onclick="sendMove()" class="btn-exec">SEND</button>
            </div>
        </div>
    </div>
</div>

<div id="game-data" 
     data-match-id="{{ match.id }}" 
     data-board='{{ board_data|safe }}' 
     data-user-color="{{ user_color }}"
     data-turn="{{ current_turn }}">
</div>

<script>
const PIECE_URL = "https://upload.wikimedia.org/wikipedia/commons/thumb/";
const PIECE_MAP = {
    'r':'f/ff/Chess_rdt45.svg/80px-Chess_rdt45.svg.png', 'n':'e/ef/Chess_ndt45.svg/80px-Chess_ndt45.svg.png',
    'b':'9/98/Chess_bdt45.svg/80px-Chess_bdt45.svg.png', 'q':'4/47/Chess_qdt45.svg/80px-Chess_qdt45.svg.png',
    'k':'f/f0/Chess_kdt45.svg/80px-Chess_kdt45.svg.png', 'p':'c/c7/Chess_pdt45.svg/80px-Chess_pdt45.svg.png',
    'R':'7/72/Chess_rlt45.svg/80px-Chess_rlt45.svg.png', 'N':'7/70/Chess_nlt45.svg/80px-Chess_nlt45.svg.png',
    'B':'b/b1/Chess_blt45.svg/80px-Chess_blt45.svg.png', 'Q':'1/15/Chess_qlt45.svg/80px-Chess_qlt45.svg.png',
    'K':'4/42/Chess_klt45.svg/80px-Chess_klt45.svg.png', 'P':'4/45/Chess_plt45.svg/80px-Chess_plt45.svg.png'
};
const COLS = ['a','b','c','d','e','f','g','h'];
const ROWS = ['8','7','6','5','4','3','2','1'];

const gameDataEl = document.getElementById('game-data');
const matchId = gameDataEl.dataset.matchId;
const userColor = gameDataEl.dataset.userColor;
let currentTurn = gameDataEl.dataset.turn;
let currentBoardData = JSON.parse(gameDataEl.dataset.board);
let selectedSquares = [];

function updateKPIs(boardData) {
    let w=0, b=0;
    const v = {'p':1, 'n':3, 'b':3, 'r':5, 'q':9, 'k':0};
    for(let k in boardData) {
        let p = boardData[k];
        let val = v[p.toLowerCase()] || 0;
        if(p === p.toUpperCase()) w += val; else b += val;
    }
    const tot = w+b;
    const pct = tot > 0 ? (w/tot)*100 : 50;
    document.getElementById('probability-bar').style.width = pct + "%";
}

function renderBoard(boardData) {
    const boardEl = document.getElementById('quantum-board');
    boardEl.innerHTML = ''; 
    let rRows = (userColor === 'black') ? [...ROWS].reverse() : ROWS;
    let rCols = (userColor === 'black') ? [...COLS].reverse() : COLS;

    rRows.forEach(row => {
        rCols.forEach(col => {
            const id = col + row;
            const sq = document.createElement('div');
            sq.className = 'square';
            sq.id = id;
            sq.classList.add((COLS.indexOf(col)+parseInt(row))%2===0 ? 'sq-dark':'sq-light');

            if (boardData[id]) {
                const p = boardData[id];
                const img = document.createElement('img');
                img.src = PIECE_URL + PIECE_MAP[p];
                img.className = 'piece-img ' + (p===p.toUpperCase() ? 'filter-white':'filter-black');
                sq.appendChild(img);
            }
            sq.onclick = () => handleSquareClick(id);
            boardEl.appendChild(sq);
        });
    });
    
    document.getElementById('turn-display').innerHTML = currentTurn === 'white' 
        ? '<span style="color:#0ff">■ WHITE TO MOVE</span>' 
        : '<span style="color:#f70">■ BLACK TO MOVE</span>';
    
    updateKPIs(boardData);
}

function handleSquareClick(id) {
    if (currentTurn !== userColor) return; 
    const el = document.getElementById(id);
    const input = document.getElementById('move-input');

    if (selectedSquares.includes(id)) {
        selectedSquares = selectedSquares.filter(s => s !== id);
        el.classList.remove('sq-source', 'sq-t1', 'sq-t2');
        input.value = '';
        return;
    }

    if (selectedSquares.length < 3) {
        selectedSquares.push(id);
        if (selectedSquares.length === 1) el.classList.add('sq-source');
        if (selectedSquares.length === 2) el.classList.add('sq-t1');
        if (selectedSquares.length === 3) el.classList.add('sq-t2');
    }

    if (selectedSquares.length === 2) input.value = selectedSquares.join('');
    else if (selectedSquares.length === 3) {
        input.value = `${selectedSquares[0]}${selectedSquares[1]}^${selectedSquares[0]}${selectedSquares[2]}`;
    }
}

function clearSelection() {
    selectedSquares.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.remove('sq-source', 'sq-t1', 'sq-t2');
    });
    selectedSquares = [];
    document.getElementById('move-input').value = '';
}

async function sendMove() {
    const input = document.getElementById('move-input');
    const moveStr = input.value;
    if (!moveStr) return;

    document.getElementById('ai-loader').style.display = 'block';
    
    try {
        const res = await fetch(`/tournament/move/${matchId}`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ move_str: moveStr })
        });
        const data = await res.json();

        if (data.success) {
            document.getElementById('logs').innerHTML += `<div style="color:#0f0">> Move Executed</div>`;
            currentBoardData = data.board_data;
            currentTurn = (currentTurn === 'white') ? 'black' : 'white';
            
            if (data.game_over) {
                alert(`GAME OVER! Winner: ${data.winner.toUpperCase()}`);
                window.location.reload();
            }
            renderBoard(currentBoardData);
            clearSelection();
        } else {
            document.getElementById('logs').innerHTML += `<div style="color:#f44">> ${data.message}</div>`;
        }
    } catch (e) { console.error(e); }
    document.getElementById('ai-loader').style.display = 'none';
}

renderBoard(currentBoardData);
</script>

<style>
    .dashboard-wrapper { display: grid; grid-template-columns: 450px 1fr; gap: 20px; max-width: 900px; margin: 40px auto; }
    .board-grid { display: grid; grid-template-columns: repeat(8, 1fr); width: 400px; height: 400px; border: 4px solid var(--primary); }
    .square { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; }
    .sq-light { background: #1a2a1a; } .sq-dark { background: #000; }
    
    .sq-source { background: rgba(0, 255, 255, 0.3) !important; box-shadow: inset 0 0 10px cyan; }
    .sq-t1 { background: rgba(0, 255, 0, 0.3) !important; }
    .sq-t2 { background: rgba(255, 255, 0, 0.3) !important; }

    .piece-img { width: 85%; transition: 0.2s; }
    /* HIGH CONTRAST FILTERS */
    .filter-white { filter: invert(1) sepia(1) saturate(10) hue-rotate(160deg) brightness(2) drop-shadow(0 0 5px cyan); }
    .filter-black { filter: invert(1) sepia(1) saturate(8) hue-rotate(-30deg) brightness(1.5) drop-shadow(0 0 5px #f40); }

    .panel { background: rgba(0, 15, 0, 0.9); border: 1px solid var(--primary-dim); padding: 15px; margin-bottom: 15px; }
    .logs-panel { height: 150px; overflow-y: auto; background: #000; font-family: monospace; font-size: 0.8rem; color: var(--primary); }
    
    .progress-track { height: 10px; background: #220; border: 1px solid #555; position: relative; margin-top:10px; }
    .progress-fill { height: 100%; background: cyan; transition: width 0.5s; box-shadow: 0 0 10px cyan; }
    
    .btn-clear { background: #333; color: white; border: 1px solid #666; cursor: pointer; padding: 5px 10px; }
    .btn-exec { background: var(--primary); color: black; font-weight: bold; border: none; padding: 10px 20px; cursor: pointer; }
    .blink { animation: blink 1s infinite; } @keyframes blink { 50% { opacity: 0; } }
</style>
{% endblock %}
