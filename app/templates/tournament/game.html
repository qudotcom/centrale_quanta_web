{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

<div class="game-layout">
    
    <div class="board-container">
        <div id="myBoard"></div>
        
        <div class="status-bar">
            <span class="indicator"></span> LIVE UPLINK
        </div>
        
        <div class="instructions">
            <small>
                <strong>CONTROLS:</strong><br>
                1. <strong>Standard Move:</strong> Drag & Drop (e.g., e2 to e4)<br>
                2. <strong>Quantum Split:</strong> Use Terminal (e.g., b1a3^b1c3)
            </small>
        </div>
    </div>

    <div class="control-panel">
        <div class="match-info">
            <div class="player-row">
                <span class="p-label">WHITE</span>
                <span class="p-name">{{ match.player1.username }}</span>
            </div>
            <div class="player-row">
                <span class="p-label">BLACK</span>
                <span class="p-name">{{ match.player2.username }}</span>
            </div>
        </div>

        <div class="logs" id="game-logs">
            <div>> System Initialized.</div>
            <div>> Waiting for quantum collapse...</div>
        </div>

        <div class="input-area">
            <label>QUANTUM TERMINAL:</label>
            <div class="input-group">
                <input type="text" id="move-input" placeholder="Enter split move..." autocomplete="off">
                <button onclick="submitManualMove()" class="btn">SEND</button>
            </div>
        </div>
    </div>

</div>

<div id="game-data" 
     data-match-id="{{ match.id }}" 
     data-fen="{{ fen }}" 
     data-orientation="{{ orientation }}"
     style="display: none;">
</div>

<script>
var board = null;
var gameMatchId = document.getElementById('game-data').dataset.matchId;
var startFen = document.getElementById('game-data').dataset.fen;
var orientationType = document.getElementById('game-data').dataset.orientation;

function onDrop (source, target) {
    if (source === target) return;
    var move = source.toLowerCase() + target.toLowerCase();
    submitMoveToServer(move);
}

// Fixed Board Config
var config = {
    draggable: true,
    position: startFen,
    orientation: orientationType,
    onDrop: onDrop,
    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
}
board = Chessboard('myBoard', config)

// Responsive fix
window.addEventListener('resize', board.resize);

async function submitMoveToServer(moveStr) {
    const logPanel = document.getElementById('game-logs');
    logPanel.innerHTML += `<div>> Executing: ${moveStr}</div>`;
    logPanel.scrollTop = logPanel.scrollHeight;

    try {
        const response = await fetch(`/tournament/move/${gameMatchId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ move_str: moveStr })
        });
        const data = await response.json();

        if (data.success) {
            logPanel.innerHTML += `<div style="color: #0f0;">> MOVE SUCCESS.</div>`;
            board.position(data.fen);
        } else {
            logPanel.innerHTML += `<div style="color: #f00;">> ERROR: ${data.message}</div>`;
            board.position(startFen); // Snapback
        }
    } catch (error) {
        logPanel.innerHTML += `<div style="color: #f00;">> SIGNAL LOST</div>`;
    }
}

function submitManualMove() {
    var input = document.getElementById('move-input');
    if(input.value) {
        submitMoveToServer(input.value);
        input.value = '';
    }
}

document.getElementById('move-input').addEventListener("keypress", function(e) {
    if (e.key === "Enter") submitManualMove();
});
</script>

<style>
    /* 1. LAYOUT GRID */
    .game-layout {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 40px;
        margin-top: 40px;
        padding: 0 20px;
    }

    /* 2. BOARD SIZE LOCK - This fixes the "Too Big" issue */
    .board-container {
        width: 100%;
        max-width: 450px; /* <--- CRITICAL FIX */
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* 3. CONTROL PANEL */
    .control-panel {
        flex: 1;
        min-width: 300px;
        max-width: 400px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* STYLING DETAILS */
    .match-info {
        border: 1px solid var(--primary);
        padding: 15px;
        background: rgba(0, 20, 0, 0.8);
    }
    .player-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        border-bottom: 1px dashed var(--primary-dim);
    }
    .player-row:last-child { border: none; }
    
    .logs {
        height: 250px;
        background: #000;
        border: 1px solid var(--primary-dim);
        overflow-y: auto;
        padding: 10px;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        color: var(--primary);
        box-shadow: inset 0 0 10px rgba(0,255,0,0.1);
    }

    .input-group {
        display: flex;
        gap: 10px;
    }
    
    .status-bar {
        text-align: center;
        color: var(--primary);
        font-size: 0.8rem;
        letter-spacing: 2px;
    }
    .indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: var(--primary);
        border-radius: 50%;
        margin-right: 5px;
        box-shadow: 0 0 5px var(--primary);
    }
    
    .instructions {
        text-align: center;
        color: #888;
        font-size: 0.8rem;
    }

    /* CHESSBOARD THEME OVERRIDES */
    .board-b72b1 {
        border: 4px solid var(--primary-dim);
        box-shadow: 0 0 25px rgba(0, 255, 65, 0.15);
    }
    .black-3c85d { background-color: #111 !important; }
    .white-1e1d7 { background-color: #2a3a2a !important; }
    
    /* GREEN HOLOGRAM PIECES */
    .piece-417db {
        filter: invert(1) sepia(1) saturate(5) hue-rotate(90deg);
        opacity: 0.9;
        transition: transform 0.1s;
    }
    .piece-417db:hover {
        transform: scale(1.1);
        filter: invert(1) sepia(1) saturate(10) hue-rotate(90deg) drop-shadow(0 0 8px var(--primary));
        cursor: grab;
    }
</style>
{% endblock %}
